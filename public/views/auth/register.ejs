<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>회원가입</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/auth.css">
</head>
<body>
  <%- include("../partials/header") %>

  <div class="auth-wrap">
    <h1 class="auth-title">회원가입</h1>

    <% if (error) { %>
      <div class="auth-error"><%= error %></div>
    <% } %>

    <form method="POST" action="/register" class="auth-form">
      <input name="uniqueCode" placeholder="고유번호" value="<%= (form.uniqueCode||'') %>" class="auth-input" />
      <input name="nickname" placeholder="닉네임" value="<%= (form.nickname||'') %>" class="auth-input" />
      <input name="username" placeholder="아이디" value="<%= (form.username||'') %>" class="auth-input" />
      <input name="password" type="password" placeholder="비밀번호" class="auth-input" />

      <div>
        <label>
          <input type="checkbox" name="agree" required />
          <span>
            <a href="/terms" target="_blank">이용약관</a> 및
            <a href="/privacy" target="_blank">개인정보 처리방침</a>에 동의합니다.
          </span>
        </label>
      </div>

      <div class="discord-link-box">
        <% if (discordLink && discordLink.discord_id) { %>
          <div class="auth-box-info auth-box-discord-ok">
            ✅ 디스코드 연결됨: <strong><%= discordLink.discord_name %></strong>
            <div style="margin-top:8px;">
              <a href="/auth/discord/unlink" class="auth-link">연결 해제</a>
            </div>
          </div>
        <% } else { %>
          <div class="auth-box-info auth-box-discord-warn">
            <div style="font-weight:900;margin-bottom:8px;">⚠️ 디스코드 계정 연결이 필요합니다.</div>
            <a href="/auth/discord/link" class="auth-discord-btn">디스코드 연결하기</a>
          </div>
        <% } %>
      </div>

      <button type="submit" class="auth-btn-primary">가입하기</button>
    </form>

    <div style="margin-top:14px;">
      <a href="/login" class="auth-link">이미 계정이 있어요 → 로그인</a>
    </div>
  </div>

  <!-- 로컬스토리지 자동 복원 -->
  <script>
    (function () {
      const KEY = "jp_register_draft_v1";
      const form = document.querySelector('form[action="/register"]');
      if (!form) return;

      const TEXT_FIELDS = ["uniqueCode", "nickname", "username"];
      const CHECK_FIELDS = ["agree"];

      function qs(name) {
        return form.querySelector(`[name="${name}"]`);
      }

      function loadDraft() {
        try {
          const raw = localStorage.getItem(KEY);
          if (!raw) return;
          const draft = JSON.parse(raw);

          TEXT_FIELDS.forEach((name) => {
            const el = qs(name);
            if (!el) return;
            if (!el.value && draft[name] != null) el.value = String(draft[name]);
          });

          CHECK_FIELDS.forEach((name) => {
            const el = qs(name);
            if (!el) return;
            if (typeof draft[name] === "boolean") el.checked = draft[name];
          });
        } catch (e) {
          try { localStorage.removeItem(KEY); } catch (_) {}
        }
      }

      function saveDraft() {
        const draft = {};
        TEXT_FIELDS.forEach((name) => {
          const el = qs(name);
          draft[name] = el ? el.value : "";
        });
        CHECK_FIELDS.forEach((name) => {
          const el = qs(name);
          draft[name] = !!(el && el.checked);
        });

        try {
          localStorage.setItem(KEY, JSON.stringify(draft));
        } catch (e) {}
      }

      loadDraft();
      form.addEventListener("input", saveDraft);
      form.addEventListener("change", saveDraft);
    })();
  </script>
</body>
</html>
